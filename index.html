<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>World Country Guessing Game ‚Äî UN Countries</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--ink:#e7ecff;--muted:#95a0c6;--accent:#7dd3fc;--right:#34d399;--focus:#fbbf24;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f24 60%);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  .shell{display:grid;grid-template-columns:2fr 1fr;gap:20px;min-height:100vh;padding:18px}
  @media (max-width:1000px){.shell{grid-template-columns:1fr}}
  .panel{background:var(--card);border:1px solid #1d274a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;display:flex;flex-direction:column}

  .map-wrap{position:relative;flex:1;min-height:360px}
  svg#map{display:block;width:100%;height:auto;background:#0a142c;border-radius:12px}
  .map-toolbar{position:absolute;top:10px;left:10px;display:flex;gap:8px;z-index:2}
  .toolbar-btn{padding:6px 10px;border-radius:8px;border:1px solid #2a3a6a;background:#0e1a3d;color:var(--ink);cursor:pointer;font-size:.9rem}
  .toolbar-btn:hover{filter:brightness(1.08)}

  h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem}
  .pill{height:8px;background:#0a1430;border:1px solid #23325e;border-radius:999px;overflow:hidden;margin:10px 0}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#60a5fa);transition:width .3s}
  .legend{margin-top:6px;color:var(--muted);font-size:.9rem}
  .controls{display:flex;gap:8px;margin-top:10px}
  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #2a3a6a;background:#0a1430;color:var(--ink);outline:none}
  input::placeholder{color:#7b87b6}
  button{padding:12px 14px;border-radius:10px;border:1px solid #2a3a6a;background:#0e1a3d;color:var(--ink);cursor:pointer}
  button:hover{filter:brightness(1.08)}
  .secondary{background:#0a1430}
  .ghost{background:transparent}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  .stat{background:#0b1533;border:1px solid #1d274a;border-radius:12px;padding:10px;text-align:center}
  .stat .k{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .stat .v{font-size:1.6rem;font-weight:700}
  .hint{font-family:ui-monospace,Menlo,Consolas,monospace;color:#cbd5ff;background:#0b1533;border:1px dashed #33406b;border-radius:10px;padding:10px;margin-top:8px;display:none}

  .suggest-box{position:relative}
  .suggest-list{position:absolute;top:100%;left:0;right:0;z-index:5;background:#0a1430;border:1px solid #2a3a6a;border-radius:10px;margin-top:4px;max-height:220px;overflow:auto;padding:4px;}
  .suggest-item{padding:8px 10px;border-radius:8px;cursor:pointer}
  .suggest-item:hover, .suggest-item.active{background:#13214a}

  /* Soft marker & glow */
  @keyframes pulse{0%{r:3;opacity:.9}70%{r:7;opacity:.25}100%{r:3;opacity:.9}}
  .pulse-dot{animation:pulse 1.5s ease-out infinite;pointer-events:none}
  .glow{filter:url(#glowFilter);pointer-events:none}

  /* Squarespace overrides */
  .shell, .shell * { color: var(--ink); }
  input::placeholder{ color: var(--muted) !important; }
</style>
</head>
<body>
  <div class="shell">
    <!-- MAP -->
    <div class="panel">
      <div class="map-wrap">
        <div class="map-toolbar">
          <button id="resetBtn" class="toolbar-btn" type="button">üåê Reset View</button>
        </div>
        <svg id="map" viewBox="0 0 960 520">
          <defs>
            <filter id="glowFilter" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="1.2" result="blur"/>
              <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
        </svg>
      </div>
    </div>

    <!-- UI -->
    <div class="panel">
      <h1>üåç Country Guesser ‚Äî UN Countries</h1>
      <div class="sub">Scroll to zoom, drag to pan. Exact GeoJSON names, UN set only.</div>

      <div class="pill"><div class="bar" id="bar"></div></div>
      <div class="legend">‚úî Correct turns green ‚Ä¢ ‚òÖ Highlighted glows softly</div>

      <form id="form" class="controls" autocomplete="off">
        <div class="suggest-box" style="flex:1">
          <input id="guess" type="text" placeholder="Type country name‚Ä¶" />
          <div id="suggest" class="suggest-list" style="display:none"></div>
        </div>
        <button type="submit">Submit</button>
      </form>

      <div class="controls">
        <button id="hintBtn" class="secondary" type="button">Hint</button>
        <button id="revealBtn" class="ghost" type="button">Reveal</button>
        <button id="restartBtn" class="ghost" type="button">Restart</button>
      </div>

      <div id="hintBox" class="hint"></div>

      <div class="stats">
        <div class="stat"><div class="k">Score</div><div class="v" id="scoreV">0</div></div>
        <div class="stat"><div class="k">Streak</div><div class="v" id="streakV">0</div></div>
        <div class="stat"><div class="k">Progress</div><div class="v" id="progV">0/0</div></div>
      </div>
    </div>
  </div>

  <!-- Finish overlay -->
  <div id="finishOverlay" style="position:fixed; inset:0; display:none; place-items:center; background:rgba(3,10,30,.65); z-index:50;">
    <div style="background:#121a33;border:1px solid #1d274a;border-radius:16px;padding:22px;max-width:680px;width:92%;color:#e7ecff;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,.45)">
      <h2 style="margin:0 0 8px;font-weight:800;font-size:1.4rem">üèÅ You finished!</h2>
      <p id="finishStats" style="margin:0 0 16px;color:#95a0c6"></p>

      <div style="margin:10px 0 6px">
        <label for="playerName" style="display:block;margin-bottom:6px;color:#95a0c6">Add your name to the leaderboard (optional)</label>
        <input id="playerName" type="text" maxlength="40" placeholder="Your name"
               style="padding:10px 12px;border-radius:10px;border:1px solid #2a3a6a;background:#0a1430;color:#e7ecff;width:260px;">
        <button id="submitScoreBtn" class="toolbar-btn" type="button">Submit score</button>
      </div>

      <div id="leaderboard" style="margin-top:14px;text-align:left"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:16px">
        <button id="playAgainBtn" class="toolbar-btn" type="button">Play again</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
  <script>
  // === Replace with your deployed Apps Script Web App URL (ends with /exec)
  const APP_URL = 'https://script.google.com/macros/s/AKfycbzqGbIm3DpZc3Lfl5LS4eyYBA2yrXgINCz7m0OV6481Xuh90ZNRSWZYSit_RjLlwCnk/exec';

  // Dev/test helper: quick leaderboard submit
  async function testSubmit() {
    const testName = "Tester";
    const testScore = Math.floor(Math.random() * 200);
    const testTime = Math.floor(Math.random() * 500);
    const res = await fetch(APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: testName, score: testScore, time_s: testTime })
    });
    console.log("Test submission:", await res.json());
  }

  (async function () {


    async function submitScore(name, score, time_s) {
      try {
        const res = await fetch(APP_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ name, score, time_s })
        });
        return await res.json();
      } catch (e) {
        console.warn('Submit failed', e);
        return { ok:false, error:String(e) };
      }
    }

    async function loadLeaderboard() {
      try {
        const res = await fetch(APP_URL);
        const data = await res.json();
        const lb = document.getElementById('leaderboard');
        if (!data.ok) { lb.textContent = 'Unable to load leaderboard.'; return; }
        const rows = data.rows || [];
        lb.innerHTML = `
          <h3 style="margin:10px 0 6px">üèÜ Leaderboard (Top 20)</h3>
          <ol style="margin:0;padding-left:18px">
            ${rows.map(r => {
              const m = Math.floor(r.time_s/60), s = String(r.time_s%60).padStart(2,'0');
              return `<li><strong>${r.name}</strong> ‚Äî score ${r.score}, time ${m}:${s}</li>`;
            }).join('')}
          </ol>`;
      } catch (e) {
        document.getElementById('leaderboard').textContent = 'Unable to load leaderboard.';
      }
    }

    const SHAPES = "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_50m_admin_0_countries.geojson";

    // UN ISO3 set (193 + 2 observers)
    const UN_ISO3 = new Set([
      "AFG","ALB","DZA","AND","AGO","ATG","ARG","ARM","AUS","AUT","AZE","BHS","BHR","BGD","BRB","BLR","BEL","BLZ","BEN","BTN","BOL","BIH","BWA","BRA","BRN","BGR","BFA","BDI","CPV","KHM","CMR","CAN","CAF","TCD","CHL","CHN","COL","COM","COG","COD","CRI","CIV","HRV","CUB","CYP","CZE","DNK","DJI","DMA","DOM","ECU","EGY","SLV","GNQ","ERI","EST","SWZ","ETH","FJI","FIN","FRA","GAB","GMB","GEO","DEU","GHA","GRC","GRD","GTM","GIN","GNB","GUY","HTI","HND","HUN","ISL","IND","IDN","IRN","IRQ","IRL","ISR","ITA","JAM","JPN","JOR","KAZ","KEN","KIR","KWT","KGZ","LAO","LVA","LBN","LSO","LBR","LBY","LIE","LTU","LUX","MDG","MWI","MYS","MDV","MLI","MLT","MHL","MRT","MUS","MEX","FSM","MDA","MCO","MNG","MNE","MAR","MOZ","MMR","NAM","NRU","NPL","NLD","NZL","NIC","NER","NGA","PRK","MKD","NOR","OMN","PAK","PLW","PAN","PNG","PRY","PER","PHL","POL","PRT","QAT","ROU","RUS","RWA","KNA","LCA","VCT","WSM","SMR","STP","SAU","SEN","SRB","SYC","SLE","SGP","SVK","SVN","SLB","SOM","ZAF","KOR","SSD","ESP","LKA","SDN","SUR","SWE","CHE","SYR","TJK","TZA","THA","TLS","TGO","TON","TTO","TUN","TUR","TKM","TUV","UGA","UKR","ARE","GBR","USA","URY","UZB","VUT","VEN","VNM","YEM","ZMB","ZWE","VAT","PSE"
    ]);

    const ne = await (await fetch(SHAPES)).json();

    function iso3(p){
      return p.ISO_A3_EH && p.ISO_A3_EH !== "-99" ? p.ISO_A3_EH
           : p.ISO_A3 && p.ISO_A3 !== "-99" ? p.ISO_A3
           : p.ADM0_A3 || p.ALPHA3 || "";
    }
    function label(p){ return p.NAME_EN || p.ADMIN || p.NAME || p.SOVEREIGNT || "Unknown"; }

    // Keep all parts of sovereign UN members (no de-dupe; suggestions dedupe by name)
    function isUNSovereign(f){
      const p=f.properties||{}, code=iso3(p);
      if(!UN_ISO3.has(code)) return false;
      if(p.ADMIN && p.SOVEREIGNT) return p.ADMIN === p.SOVEREIGNT;
      const fc=(p.FEATURECLA||"").toLowerCase();
      const ty=(p.TYPE||"").toLowerCase();
      const isCountry = fc.includes("admin-0 country") || ty.includes("sovereign country") || ty==="country";
      const isDependency = fc.includes("dependency") || ty.includes("dependency");
      return isCountry && !isDependency;
    }
    let data = ne.features.filter(isUNSovereign);

    // Unique countries (turns / progress)
    const nameOf = f => label(f.properties);
    const UNIQUE_NAMES = Array.from(new Set(data.map(nameOf))).sort();
    const TOTAL = UNIQUE_NAMES.length;

    // Representative feature per country (for turn order)
    const repByName = new Map();
    for (const f of data) {
      const n = nameOf(f);
      if (!repByName.has(n)) repByName.set(n, f);
    }

    // Map
    const svg=d3.select("#map"),width=960,height=520;
    svg.append("rect").attr("x",0).attr("y",0).attr("width",width).attr("height",height).attr("fill","#08102a");
    const gMap=svg.append("g");
    const projection=d3.geoEqualEarth().fitExtent([[10,10],[width-10,height-10]],{type:"Sphere"});
    const path=d3.geoPath(projection);

    let countriesSel = gMap.selectAll("path.country").data(data).enter().append("path")
      .attr("class","country")
      .attr("d", d => path(d))
      .attr("fill","#33436d")
      .attr("stroke","#0f1f4a")
      .attr("stroke-width",0.5);

    const glowPath=gMap.append("path").attr("class","glow").attr("fill","none").attr("stroke","#fbbf24").attr("stroke-width",1.5).attr("opacity",0.55);
    const dot=gMap.append("circle").attr("class","pulse-dot").attr("r",3).attr("fill","#fbbf24").attr("stroke","#0a0a0a").attr("stroke-width",0.4);

    const zoom=d3.zoom().scaleExtent([1,12]).on("zoom",ev=>gMap.attr("transform",ev.transform));
    svg.call(zoom);
    document.getElementById("resetBtn").addEventListener("click",()=>svg.transition().duration(400).call(zoom.transform,d3.zoomIdentity));

    // Game state
    let order = d3.shuffle(Array.from(repByName.values())); // one turn per country
    let idx = 0, solved = 0, streak = 0, score = 0;
    const solvedSet = new Set();

    const guessInput=document.getElementById("guess"),
          hintBox=document.getElementById("hintBox"),
          scoreV=document.getElementById("scoreV"),
          streakV=document.getElementById("streakV"),
          progV=document.getElementById("progV"),
          bar=document.getElementById("bar");

    let hintLen = 0;
    let startTs = Date.now();

    const currentFeature = () => order[idx];

    function repaint(){
      countriesSel.attr("fill", d => {
        const n = nameOf(d);
        if (d===currentFeature()) return "#f59e0b";
        if (solvedSet.has(n))   return "#10b981";
        return "#33436d";
      });
      const cur=currentFeature();
      glowPath.attr("d", path(cur));
      const [cx,cy] = path.centroid(cur);
      dot.attr("cx",cx).attr("cy",cy);
    }

    function updateUI(){
      const pct=Math.round((solved/TOTAL)*100);
      scoreV.textContent  = String(score);
      streakV.textContent = String(streak);
      progV.textContent   = `${solved} / ${TOTAL}`;
      bar.style.width=pct+"%";
      repaint();
    }

    async function finish() {
      const ms = Date.now() - startTs;
      const secs = Math.round(ms/1000);
      const mm = String(Math.floor(secs/60)).padStart(2,"0");
      const ss = String(secs%60).padStart(2,"0");
      const overlay = document.getElementById("finishOverlay");
      const statsEl = document.getElementById("finishStats");
      statsEl.innerHTML = `Score: <b>${score}</b> &nbsp;‚Ä¢&nbsp; Time: <b>${mm}:${ss}</b> &nbsp;‚Ä¢&nbsp; Progress: <b>${TOTAL}/${TOTAL}</b>`;
      overlay.style.display = "grid";

      // Preload leaderboard
      loadLeaderboard();

      // Wire submit button (in case user clicks after overlay shows)
      document.getElementById('submitScoreBtn').onclick = async () => {
        const name = (document.getElementById('playerName').value || '').trim();
        if (!name) return;
        const res = await submitScore(name, score, secs);
        await loadLeaderboard();
        // Optional: disable after submit
        document.getElementById('submitScoreBtn').disabled = true;
      };
    }

    function next(){
      if (solved >= TOTAL) { finish(); return; }
      idx = Math.min(idx+1, order.length-1);
      hintLen = 0;
      hintBox.style.display="none";
      hintBox.textContent = "";
      guessInput.value="";
      updateUI();
    }

    updateUI();
    guessInput.focus();

    // Suggestions
    const suggestBox=document.getElementById("suggest");
    let suggestions=[],activeIndex=-1;

    function remainingNames(){ return UNIQUE_NAMES.filter(n => !solvedSet.has(n)); }
    function buildSuggestions(q){
      const rem=remainingNames();
      if(!q) return rem.slice(0,20);
      const ql=q.toLowerCase();
      const starts=rem.filter(n=>n.toLowerCase().startsWith(ql));
      const contains=rem.filter(n=>!n.toLowerCase().startsWith(ql)&&n.toLowerCase().includes(ql));
      return [...starts,...contains].slice(0,20);
    }
    function renderSuggestions(){
      if(!suggestions.length){suggestBox.style.display="none";suggestBox.innerHTML="";return;}
      suggestBox.style.display="block";
      suggestBox.innerHTML=suggestions.map((s,i)=>`<div class="suggest-item${i===activeIndex?' active':''}" data-i="${i}">${s}</div>`).join("");
    }
    function setActive(i){
      if(!suggestions.length){activeIndex=-1;renderSuggestions();return;}
      activeIndex=((i%suggestions.length)+suggestions.length)%suggestions.length;
      renderSuggestions();
    }
    suggestBox.addEventListener("mousedown",e=>{
      const item=e.target.closest(".suggest-item");
      if(!item) return;
      const i=+item.dataset.i;
      if(Number.isFinite(i)){
        guessInput.value=suggestions[i];
        document.getElementById("form").dispatchEvent(new Event("submit",{cancelable:true}));
      }
    });
    guessInput.addEventListener("input",()=>{
      suggestions=buildSuggestions(guessInput.value);
      activeIndex=-1; renderSuggestions();
    });
    guessInput.addEventListener("keydown",e=>{
      if(e.key==="Tab"){
        if(suggestions.length){ e.preventDefault(); setActive(activeIndex+1); guessInput.value=suggestions[activeIndex]; }
      }
      if(e.key==="Enter"){
        if(suggestions.length){ guessInput.value = (activeIndex<0) ? suggestions[0] : suggestions[activeIndex]; }
      }
      if(e.key==="Escape"){ suggestBox.style.display="none"; activeIndex=-1; }
    });
    document.addEventListener("click",e=>{
      if(!document.getElementById("form").contains(e.target)){ suggestBox.style.display="none"; activeIndex=-1; }
    });

    // Submit (+1 / ‚àí1)
    document.getElementById("form").addEventListener("submit", (e) => {
      e.preventDefault();
      const cur  = currentFeature();
      const name = nameOf(cur);
      const guess = (guessInput.value||"").trim();

      if (guess && guess.toLowerCase() === name.toLowerCase()) {
        if (!solvedSet.has(name)) {
          solvedSet.add(name);
          solved++;
          streak++;
          score++; // +1 correct
        }
        suggestions = []; activeIndex = -1; renderSuggestions();
        next();
      } else {
        streak = 0;
        score--; // ‚àí1 wrong
        guessInput.animate(
          [{transform:"translateX(0)"},{transform:"translateX(-3px)"},{transform:"translateX(3px)"},{transform:"translateX(0)"}],
          {duration:150}
        );
        updateUI();
      }
    });

    // Hint / Reveal / Restart
    document.getElementById("hintBtn").addEventListener("click", () => {
      const n = nameOf(currentFeature());
      hintLen = Math.min(hintLen + 1, n.length);
      hintBox.style.display = "block";
      hintBox.textContent = "Hint: " + n.slice(0,hintLen) + "‚ñÅ".repeat(Math.max(0,n.length-hintLen));
      guessInput.focus();
    });

    document.getElementById("revealBtn").addEventListener("click", () => {
      const n = nameOf(currentFeature());
      hintBox.style.display = "block";
      hintBox.innerHTML = `Revealed: <strong>${n}</strong>`;
      streak = 0;
      setTimeout(() => next(), 600);
    });

    document.getElementById("restartBtn").addEventListener("click", () => {
      order  = d3.shuffle(Array.from(repByName.values()));
      idx    = 0;
      solved = 0;
      streak = 0;
      score  = 0;
      solvedSet.clear();
      hintLen = 0;
      hintBox.style.display = "none";
      hintBox.textContent = "";
      document.getElementById("finishOverlay").style.display = "none";
      document.getElementById("playerName").value = "";
      document.getElementById("submitScoreBtn").disabled = false;
      guessInput.value = "";
      suggestions = []; activeIndex = -1; renderSuggestions();
      startTs = Date.now();
      updateUI();
      svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity);
    });

    // Click highlighted country to mark correct (+1)
    countriesSel.on("click", (ev, d) => {
      if (d === currentFeature()) {
        const n = nameOf(d);
        if (!solvedSet.has(n)) {
          solvedSet.add(n);
          solved++;
          streak++;
          score++;
        }
        next();
        updateUI();
      }
    });

    // Finish overlay "Play again"
    document.getElementById("playAgainBtn").addEventListener("click", () => {
      document.getElementById("restartBtn").click();
    });
  })();
  </script>
</body>
</html>
