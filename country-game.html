<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>World Country Guessing Game ‚Äî UN Countries (manual zoom, softer glow)</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--ink:#e7ecff;--muted:#95a0c6;--accent:#7dd3fc;--right:#34d399;--focus:#fbbf24;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f24 60%);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  .shell{display:grid;grid-template-columns:2fr 1fr;gap:20px;min-height:100vh;padding:18px}
  @media (max-width:1000px){.shell{grid-template-columns:1fr}}
  .panel{background:var(--card);border:1px solid #1d274a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;display:flex;flex-direction:column}

  .map-wrap{position:relative;flex:1;min-height:360px}
  svg#map{display:block;width:100%;height:auto;background:#0a142c;border-radius:12px}
  .map-toolbar{position:absolute;top:10px;left:10px;display:flex;gap:8px;z-index:2}
  .toolbar-btn{padding:6px 10px;border-radius:8px;border:1px solid #2a3a6a;background:#0e1a3d;color:var(--ink);cursor:pointer;font-size:.9rem}
  .toolbar-btn:hover{filter:brightness(1.08)}

  h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:.95rem}
  .pill{height:8px;background:#0a1430;border:1px solid #23325e;border-radius:999px;overflow:hidden;margin:10px 0}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#60a5fa);transition:width .3s}
  .legend{margin-top:6px;color:var(--muted);font-size:.9rem}
  .controls{display:flex;gap:8px;margin-top:10px}
  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #2a3a6a;background:#0a1430;color:var(--ink);outline:none}
  input::placeholder{color:#7b87b6}
  button{padding:12px 14px;border-radius:10px;border:1px solid #2a3a6a;background:#0e1a3d;color:var(--ink);cursor:pointer}
  button:hover{filter:brightness(1.08)}
  .secondary{background:#0a1430}
  .ghost{background:transparent}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  .stat{background:#0b1533;border:1px solid #1d274a;border-radius:12px;padding:10px;text-align:center}
  .stat .k{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .stat .v{font-size:1.6rem;font-weight:700}
  .hint{font-family:ui-monospace,Menlo,Consolas,monospace;color:#cbd5ff;background:#0b1533;border:1px dashed #33406b;border-radius:10px;padding:10px;margin-top:8px;display:none}

  /* Suggestion dropdown */
  .suggest-box{position:relative}
  .suggest-list{
    position:absolute; top:100%; left:0; right:0; z-index:5;
    background:#0a1430; border:1px solid #2a3a6a; border-radius:10px; margin-top:4px;
    max-height:220px; overflow:auto; padding:4px;
  }
  .suggest-item{padding:8px 10px; border-radius:8px; cursor:pointer}
  .suggest-item:hover, .suggest-item.active{background:#13214a}
  .suggest-empty{padding:8px 10px; color:#7b87b6}

  /* Softer locator & glow */
  @keyframes pulse{0%{r:3;opacity:.9}70%{r:7;opacity:.25}100%{r:3;opacity:.9}}
  .pulse-dot{animation:pulse 1.5s ease-out infinite; pointer-events:none}
  .glow{filter:url(#glowFilter); pointer-events:none}
</style>
</head>
<body>
  <div class="shell">
    <!-- MAP -->
    <div class="panel">
      <div class="map-wrap">
        <div class="map-toolbar">
          <button id="resetBtn" class="toolbar-btn" type="button">üåê World view</button>
        </div>
        <svg id="map" viewBox="0 0 960 520" aria-label="World map">
          <defs>
            <!-- Softer glow: smaller blur, thinner line combined with low opacity stroke -->
            <filter id="glowFilter" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="1.2" result="blur"/>
              <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
        </svg>
      </div>
    </div>

    <!-- UI -->
    <div class="panel">
      <h1>üåç Country Guesser ‚Äî UN Countries</h1>
      <div class="sub">Scroll to zoom, drag to pan (no auto-zoom). Exact GeoJSON names, UN set only.</div>

      <div class="pill" aria-label="Progress"><div class="bar" id="bar"></div></div>
      <div class="legend">‚úî Correct turns green ‚Ä¢ ‚òÖ Highlighted has a subtle glow ‚Ä¢ Locator dot marks centroid</div>

      <form id="form" class="controls" autocomplete="off">
        <div class="suggest-box" style="flex:1">
          <input id="guess" type="text" placeholder="Type country name‚Ä¶" />
          <div id="suggest" class="suggest-list" style="display:none"></div>
        </div>
        <button type="submit">Submit</button>
      </form>

      <div class="controls">
        <button id="hintBtn" class="secondary" type="button">Hint</button>
        <button id="revealBtn" class="ghost" type="button">Reveal</button>
        <button id="restartBtn" class="ghost" type="button">Restart</button>
      </div>

      <div id="hintBox" class="hint"></div>

      <div class="stats">
        <div class="stat"><div class="k">Score</div><div class="v" id="scoreV">0</div></div>
        <div class="stat"><div class="k">Streak</div><div class="v" id="streakV">0</div></div>
        <div class="stat"><div class="k">Progress</div><div class="v" id="progV">0%</div></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
  <script>
  (async function () {
    // Natural Earth Admin-0 Countries (50m)
    const SHAPES =
      "https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_50m_admin_0_countries.geojson";

    // UN ISO-3 allowlist (193 + 2 observers)
    const UN_ISO3 = new Set([
      "AFG","ALB","DZA","AND","AGO","ATG","ARG","ARM","AUS","AUT","AZE",
      "BHS","BHR","BGD","BRB","BLR","BEL","BLZ","BEN","BTN","BOL","BIH","BWA","BRA","BRN","BGR","BFA","BDI",
      "CPV","KHM","CMR","CAN","CAF","TCD","CHL","CHN","COL","COM",
      "COG","COD","CRI","CIV","HRV","CUB","CYP","CZE",
      "DNK","DJI","DMA","DOM","ECU","EGY","SLV","GNQ","ERI","EST","SWZ","ETH",
      "FJI","FIN","FRA","GAB","GMB","GEO","DEU","GHA","GRC","GRD","GTM","GIN","GNB","GUY",
      "HTI","HND","HUN","ISL","IND","IDN","IRN","IRQ","IRL","ISR","ITA",
      "JAM","JPN","JOR","KAZ","KEN","KIR","KWT","KGZ",
      "LAO","LVA","LBN","LSO","LBR","LBY","LIE","LTU","LUX",
      "MDG","MWI","MYS","MDV","MLI","MLT","MHL","MRT","MUS","MEX","FSM","MDA","MCO","MNG","MNE","MAR","MOZ","MMR",
      "NAM","NRU","NPL","NLD","NZL","NIC","NER","NGA","PRK","MKD","NOR",
      "OMN","PAK","PLW","PAN","PNG","PRY","PER","PHL","POL","PRT","QAT",
      "ROU","RUS","RWA","KNA","LCA","VCT","WSM","SMR","STP","SAU","SEN","SRB","SYC","SLE","SGP","SVK","SVN","SLB","SOM","ZAF","KOR","SSD","ESP","LKA","SDN","SUR","SWE","CHE","SYR",
      "TJK","TZA","THA","TLS","TGO","TON","TTO","TUN","TUR","TKM","TUV",
      "UGA","UKR","ARE","GBR","USA","URY","UZB",
      "VUT","VEN","VNM","YEM","ZMB","ZWE",
      "VAT","PSE"
    ]);

    // Helpers: exact dataset props (no aliasing)
    function iso3(props){
      return props.ISO_A3_EH && props.ISO_A3_EH !== "-99" ? props.ISO_A3_EH
           : props.ISO_A3 && props.ISO_A3 !== "-99" ? props.ISO_A3
           : props.ADM0_A3 || props.ALPHA3 || "";
    }
    function label(props){
      return props.NAME_EN || props.ADMIN || props.NAME || props.SOVEREIGNT || "Unknown";
    }

    // Load & filter (keep ALL parts of sovereign countries; no de-dupe)
    const ne = await (await fetch(SHAPES)).json();

    // Robust ISO3 getter (unchanged)
    function iso3(props){
    return props.ISO_A3_EH && props.ISO_A3_EH !== "-99" ? props.ISO_A3_EH
        : props.ISO_A3 && props.ISO_A3 !== "-99" ? props.ISO_A3
        : props.ADM0_A3 || props.ALPHA3 || "";
    }

    // Sovereign-country filter: keep only UN ISO3 AND ADMIN === SOVEREIGNT
    function isUNSovereign(f) {
    const p = f.properties || {};
    const code = iso3(p);
    if (!UN_ISO3.has(code)) return false;

    // Prefer the exact sovereign test when available
    if (p.ADMIN && p.SOVEREIGNT) {
        return p.ADMIN === p.SOVEREIGNT;
    }

    // Fallback if fields are missing: keep admin-0 countries, drop dependencies
    const fc = (p.FEATURECLA || "").toLowerCase();
    const ty = (p.TYPE || "").toLowerCase();
    const isCountry = fc.includes("admin-0 country") || ty.includes("sovereign country") || ty === "country";
    const isDependency = fc.includes("dependency") || ty.includes("dependency");
    return isCountry && !isDependency;
    }

    // Final dataset: ALL sovereign features (includes outlying parts)
    // No ISO-3 de-duplication here.
    let data = ne.features.filter(isUNSovereign);

    // ---------- Map with manual zoom/pan ----------
    const svg = d3.select("#map");
    const width = 960, height = 520;
    svg.append("rect").attr("x",0).attr("y",0).attr("width",width).attr("height",height).attr("fill","#08102a");

    const gMap = svg.append("g");
    const projection = d3.geoEqualEarth().fitExtent([[10,10],[width-10,height-10]], {type:"Sphere"});
    const path = d3.geoPath(projection);

    let countriesSel = gMap.selectAll("path.country")
      .data(data)
      .enter().append("path")
      .attr("class","country")
      .attr("d", d => path(d))
      .attr("fill", "#33436d")
      .attr("stroke", "#0f1f4a")
      .attr("stroke-width", 0.5);

    // Subtle glow outline + centroid dot for current feature
    const glowPath = gMap.append("path")
      .attr("class","glow")
      .attr("fill","none")
      .attr("stroke","#fbbf24")     /* softer color */
      .attr("stroke-width",1.5)     /* thinner */
      .attr("opacity",0.55);        /* less aggressive */

    const dot = gMap.append("circle")
      .attr("class","pulse-dot")
      .attr("r",3)                  /* smaller */
      .attr("fill","#fbbf24")
      .attr("stroke","#0a0a0a")
      .attr("stroke-width",0.4);

    const zoom = d3.zoom().scaleExtent([1,12]).on("zoom",(ev)=>gMap.attr("transform",ev.transform));
    svg.call(zoom);
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity);
    });

    // ---------- Game state ----------
    let order = d3.shuffle(data.slice());
    let idx = 0, solved = 0, streak = 0;
    const solvedSet = new Set();

    const guessInput = document.getElementById("guess");
    const hintBox = document.getElementById("hintBox");
    const scoreV = document.getElementById("scoreV");
    const streakV = document.getElementById("streakV");
    const progV   = document.getElementById("progV");
    const bar     = document.getElementById("bar");

    // Hint state resets for each country
    let hintLen = 0;

    const currentFeature = () => order[idx];

    function repaint(){
      countriesSel.attr("fill", d => {
        const id = label(d.properties);
        if (d===currentFeature()) return "#f59e0b";   // highlighted (base fill)
        if (solvedSet.has(id)) return "#10b981";      // solved
        return "#33436d";
      });
      const cur = currentFeature();
      glowPath.attr("d", path(cur));
      const [cx,cy] = path.centroid(cur);
      dot.attr("cx",cx).attr("cy",cy);
    }

    function updateUI(){
      const pct = Math.round((solved / order.length) * 100);
      scoreV.textContent = solved; streakV.textContent = streak; progV.textContent = pct + "%";
      bar.style.width = pct + "%";
      repaint();
    }

    function next(){
      idx = Math.min(idx+1, order.length-1);
      hintLen = 0;                       // reset hint counter for new country
      hintBox.style.display="none";
      hintBox.textContent = "";
      guessInput.value="";
      updateUI();
      // (No auto-zoom)
    }

    updateUI(); guessInput.focus();      // (No auto-zoom on load)

    // ---------- Suggestions (Tab cycles, Enter submits top) ----------
    const suggestBox = document.getElementById("suggest");
    let suggestions = [];
    let activeIndex = -1;

    function remainingNames(){
      return data.map(f=>label(f.properties)).filter(n => !solvedSet.has(n));
    }
    function buildSuggestions(q){
      const rem = remainingNames();
      if (!q) return rem.slice(0,20);
      const ql = q.toLowerCase();
      const starts = rem.filter(n => n.toLowerCase().startsWith(ql));
      const contains = rem.filter(n => !n.toLowerCase().startsWith(ql) && n.toLowerCase().includes(ql));
      return [...starts, ...contains].slice(0,20);
    }
    function renderSuggestions(){
      if (!suggestions.length){ suggestBox.style.display="none"; suggestBox.innerHTML=""; return; }
      suggestBox.style.display="block";
      suggestBox.innerHTML = suggestions.map((s,i)=>`<div class="suggest-item${i===activeIndex?' active':''}" data-i="${i}">${s}</div>`).join("");
    }
    function setActive(i){
      if (!suggestions.length) { activeIndex=-1; renderSuggestions(); return; }
      activeIndex = ((i % suggestions.length) + suggestions.length) % suggestions.length;
      renderSuggestions();
    }
    suggestBox.addEventListener("mousedown", (e)=>{
      const item = e.target.closest(".suggest-item");
      if (!item) return;
      const i = +item.dataset.i;
      if (Number.isFinite(i)) {
        guessInput.value = suggestions[i];
        document.getElementById("form").dispatchEvent(new Event("submit",{cancelable:true}));
      }
    });
    guessInput.addEventListener("input", ()=>{
      suggestions = buildSuggestions(guessInput.value);
      activeIndex = -1;
      renderSuggestions();
    });
    guessInput.addEventListener("keydown", (e)=>{
      if (e.key === "Tab") {
        if (suggestions.length){
          e.preventDefault();
          setActive(activeIndex + 1);
          guessInput.value = suggestions[activeIndex];
        }
      }
      if (e.key === "Enter") {
        if (suggestions.length) {
          if (activeIndex < 0) guessInput.value = suggestions[0];
          else guessInput.value = suggestions[activeIndex];
        }
      }
      if (e.key === "Escape") {
        suggestBox.style.display="none";
        activeIndex = -1;
      }
    });
    document.addEventListener("click",(e)=>{
      if (!document.getElementById("form").contains(e.target)){
        suggestBox.style.display="none";
        activeIndex = -1;
      }
    });

    // ---------- Form submit ----------
    document.getElementById("form").addEventListener("submit", (e) => {
      e.preventDefault();
      const cur = currentFeature();
      const curName = label(cur.properties);
      const guess = (guessInput.value||"").trim();
      if (guess && guess.toLowerCase() === curName.toLowerCase()) {
        if (!solvedSet.has(curName)) { solvedSet.add(curName); solved++; streak++; }
        suggestions = []; activeIndex = -1; renderSuggestions();
        next();
      } else {
        streak = 0;
        guessInput.animate(
          [{transform:"translateX(0)"},{transform:"translateX(-3px)"},
           {transform:"translateX(3px)"},{transform:"translateX(0)"}],
          {duration:150}
        );
        updateUI();
      }
    });

    // Hint / Reveal / Restart
    document.getElementById("hintBtn").addEventListener("click", () => {
      const name = label(currentFeature().properties);
      hintLen = Math.min(hintLen + 1, name.length);
      hintBox.style.display = "block";
      hintBox.textContent = "Hint: " + name.slice(0,hintLen) + "‚ñÅ".repeat(Math.max(0,name.length-hintLen));
      guessInput.focus();
    });
    document.getElementById("revealBtn").addEventListener("click", () => {
      const name = label(currentFeature().properties);
      hintBox.style.display = "block";
      hintBox.innerHTML = `Revealed: <strong>${name}</strong>`;
      streak = 0;
      setTimeout(() => next(), 600);
    });
    document.getElementById("restartBtn").addEventListener("click", () => {
      order = d3.shuffle(data.slice()); idx = 0; solved = 0; streak = 0; solvedSet.clear();
      hintLen = 0; hintBox.style.display = "none"; hintBox.textContent = "";
      guessInput.value = ""; suggestions = []; activeIndex = -1; renderSuggestions();
      updateUI();
      svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity);
    });

    // Click behavior (no auto-zoom; clicking non-current does nothing special)
    countriesSel.on("click", (ev, d) => {
      if (d === currentFeature()) {
        const name = label(d.properties);
        if (!solvedSet.has(name)) { solvedSet.add(name); solved++; streak++; }
        next();
        updateUI();
      }
    });
  })();
  </script>
</body>
</html>
